<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Font: Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #0f0f0f; color: #e0e0e0; font-family: 'Montserrat', sans-serif; }
        .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .input-dark { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 0.5rem; border-radius: 0.25rem; width: 100%; }
        .input-dark:focus { outline: none; border-color: #3b82f6; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.25rem; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-secondary { background: #374151; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 50; display: none; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }
    </style>
</head>
<body class="p-8 pb-32 max-w-6xl mx-auto">

    <!-- Header -->
    <header class="flex justify-between items-center mb-8 sticky top-0 bg-[#0f0f0f] z-40 py-4 border-b border-gray-800">
        <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">Portfolio Admin</h1>
        <div class="flex gap-4">
            <button onclick="openEditor()" class="btn btn-primary"><i class="fa-solid fa-plus"></i> New Post</button>
            <button onclick="saveChanges()" class="btn bg-green-600 hover:bg-green-700 text-white"><i class="fa-solid fa-save"></i> Save All Changes</button>
        </div>
    </header>

    <!-- Post List -->
    <div id="post-list" class="space-y-4">
        <!-- Posts injected here -->
    </div>

    <!-- Editor Modal -->
    <div id="editor-modal" class="modal">
        <div class="glass w-full max-w-4xl max-h-[90vh] overflow-y-auto rounded-xl p-8 shadow-2xl relative bg-[#1a1a1a]">
            <button onclick="closeEditor()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl"><i class="fa-solid fa-times"></i></button>
            
            <h2 id="editor-title" class="text-2xl font-bold mb-6">Edit Post</h2>
            
            <form id="post-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">ID (Unique)</label>
                        <input type="text" id="field-id" class="input-dark" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Title</label>
                        <input type="text" id="field-title" class="input-dark" required>
                    </div>
                </div>

                <div>
                    <label class="block text-sm text-gray-400 mb-1">Short Description (Card)</label>
                    <input type="text" id="field-shortDesc" class="input-dark">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Thumbnail Image</label>
                        <div class="flex gap-2">
                            <input type="text" id="field-thumb" class="input-dark" placeholder="assets/img/...">
                            <button type="button" class="btn btn-secondary px-3" onclick="triggerFileSelect('field-thumb', 'assets/img/gallery')"><i class="fa-solid fa-folder-open"></i></button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Thumbnail Video</label>
                        <div class="flex gap-2">
                            <input type="text" id="field-thumbVid" class="input-dark" placeholder="assets/vid/...">
                            <button type="button" class="btn btn-secondary px-3" onclick="triggerFileSelect('field-thumbVid', 'assets/vid')"><i class="fa-solid fa-folder-open"></i></button>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm text-gray-400 mb-1">Full Description (HTML Supported)</label>
                    <textarea id="field-desc" class="input-dark h-32 font-mono text-sm"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Use &lt;p&gt;, &lt;strong&gt;, etc.</p>
                </div>

                <!-- Media List -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm text-gray-400">Media Gallery</label>
                        <button type="button" onclick="addMediaItem()" class="text-xs bg-blue-600 px-2 py-1 rounded text-white">Add Media</button>
                    </div>
                    <div id="media-list" class="space-y-3 pl-4 border-l-2 border-gray-700">
                        <!-- Media items -->
                    </div>
                </div>

                <div class="pt-6 border-t border-gray-700 flex justify-end gap-4">
                    <button type="button" onclick="closeEditor()" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Post</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Hidden File Input for Uploads -->
    <input type="file" id="global-file-input" style="display: none;">

    <script>
        let posts = [];
        let editingIndex = -1;
        let activeInputId = null;
        let activeUploadFolder = 'assets/img/gallery';

        const API_URL = '/api/posts';

        // Initialize
        async function init() {
            try {
                const res = await fetch(API_URL);
                posts = await res.json();
                renderList();
            } catch (err) {
                alert('Error loading posts: ' + err.message);
            }
        }

        // Render List
        function renderList() {
            const listEl = document.getElementById('post-list');
            listEl.innerHTML = '';

            posts.forEach((post, index) => {
                const el = document.createElement('div');
                el.className = 'glass p-4 rounded-lg flex items-center gap-4 hover:bg-white/5 transition-colors';
                
                // Thumb
                let thumbHtml = '';
                if(post.thumbnailVideo) {
                    thumbHtml = `<video src="${post.thumbnailVideo}" class="w-24 h-16 object-cover rounded bg-black" muted></video>`;
                } else if(post.thumbnail) {
                    thumbHtml = `<img src="${post.thumbnail}" class="w-24 h-16 object-cover rounded bg-black">`;
                } else {
                    thumbHtml = `<div class="w-24 h-16 bg-gray-800 rounded flex items-center justify-center text-xs text-gray-500">No Thumb</div>`;
                }

                el.innerHTML = `
                    <div class="flex flex-col gap-1">
                        <button onclick="movePost(${index}, -1)" class="text-gray-500 hover:text-white" ${index === 0 ? 'disabled style="opacity:0.3"' : ''}><i class="fa-solid fa-chevron-up"></i></button>
                        <button onclick="movePost(${index}, 1)" class="text-gray-500 hover:text-white" ${index === posts.length - 1 ? 'disabled style="opacity:0.3"' : ''}><i class="fa-solid fa-chevron-down"></i></button>
                    </div>
                    ${thumbHtml}
                    <div class="flex-1">
                        <div class="font-bold text-lg">${post.title}</div>
                        <div class="text-xs text-gray-400 font-mono">${post.id}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openEditor(${index})" class="btn btn-secondary text-sm"><i class="fa-solid fa-pen"></i> Edit</button>
                        <button onclick="deletePost(${index})" class="btn btn-danger text-sm"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                listEl.appendChild(el);
            });
        }

        // Actions
        function movePost(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= posts.length) return;
            
            const temp = posts[index];
            posts[index] = posts[newIndex];
            posts[newIndex] = temp;
            renderList();
        }

        function deletePost(index) {
            if(confirm('Are you sure you want to delete this post?')) {
                posts.splice(index, 1);
                renderList();
            }
        }

        async function saveChanges() {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(posts)
                });
                if(res.ok) {
                    alert('Changes saved successfully!');
                } else {
                    alert('Failed to save changes.');
                }
            } catch(e) {
                alert('Error: ' + e.message);
            }
        }

        // Editor
        const modal = document.getElementById('editor-modal');
        const form = document.getElementById('post-form');
        const mediaListEl = document.getElementById('media-list');

        function openEditor(index = -1) {
            editingIndex = index;
            document.getElementById('editor-title').textContent = index >= 0 ? 'Edit Post' : 'New Post';
            
            if (index >= 0) {
                const p = posts[index];
                document.getElementById('field-id').value = p.id || '';
                document.getElementById('field-title').value = p.title || '';
                document.getElementById('field-shortDesc').value = p.shortDescription || '';
                document.getElementById('field-thumb').value = p.thumbnail || '';
                document.getElementById('field-thumbVid').value = p.thumbnailVideo || '';
                document.getElementById('field-desc').value = p.description || '';
                renderMediaInputs(p.media || []);
            } else {
                form.reset();
                renderMediaInputs([]);
            }
            modal.classList.add('active');
        }

        function closeEditor() {
            modal.classList.remove('active');
        }

        function renderMediaInputs(mediaArray) {
            mediaListEl.innerHTML = '';
            mediaArray.forEach((item, idx) => {
                addMediaItem(item);
            });
        }

        function addMediaItem(item = { type: 'image', src: '' }) {
            // Generate a unique ID for the input field to target it with the file picker
            const uniqueId = 'media-input-' + Date.now() + Math.random().toString(36).substr(2, 9);
            
            const div = document.createElement('div');
            div.className = 'grid grid-cols-12 gap-2 items-center bg-black/20 p-2 rounded';
            div.innerHTML = `
                <select class="input-dark col-span-3 text-xs media-type" onchange="toggleBrowseBtn(this, '${uniqueId}-btn')">
                    <option value="image" ${item.type === 'image' ? 'selected' : ''}>Image</option>
                    <option value="video" ${item.type === 'video' ? 'selected' : ''}>Video</option>
                    <option value="youtube" ${item.type === 'youtube' ? 'selected' : ''}>YouTube</option>
                </select>
                <div class="col-span-8 flex gap-2">
                     <input type="text" id="${uniqueId}" class="input-dark text-xs media-src w-full" value="${item.src || ''}" placeholder="Source Path / ID">
                     <button type="button" id="${uniqueId}-btn" class="btn btn-secondary px-2 text-xs" 
                        onclick="triggerFileSelect('${uniqueId}', 'assets/img/gallery')" 
                        style="${item.type === 'youtube' ? 'display:none' : ''}">
                        <i class="fa-solid fa-folder-open"></i>
                     </button>
                </div>
                <button type="button" onclick="this.parentElement.parentElement.remove()" class="col-span-1 text-red-500 hover:text-red-400 text-center"><i class="fa-solid fa-times"></i></button>
            `;
            mediaListEl.appendChild(div);
        }

        function toggleBrowseBtn(selectEl, btnId) {
            const btn = document.getElementById(btnId);
            if(selectEl.value === 'youtube') {
                btn.style.display = 'none';
            } else {
                btn.style.display = 'block';
                // Update folder based on type? Optional, but defaults to gallery for now.
            }
        }

        // File Selection Logic
        const fileInput = document.getElementById('global-file-input');
        
        function triggerFileSelect(targetInputId, folder) {
            activeInputId = targetInputId;
            activeUploadFolder = folder;
            fileInput.value = ''; // Reset
            fileInput.click();
        }

        fileInput.addEventListener('change', async () => {
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const inputEl = document.getElementById(activeInputId);
                
                // Show loading state?
                const originalPlaceholder = inputEl.placeholder;
                inputEl.placeholder = "Uploading...";
                
                try {
                    // Upload the file
                    const res = await fetch(`/api/upload?filename=${encodeURIComponent(file.name)}&folder=${encodeURIComponent(activeUploadFolder)}`, {
                        method: 'POST',
                        body: file
                    });
                    
                    if (res.ok) {
                        const data = await res.json();
                        inputEl.value = data.path; // Update input with web path
                    } else {
                        alert('Upload failed.');
                    }
                } catch (e) {
                    console.error(e);
                    alert('Upload error: ' + e.message);
                } finally {
                    inputEl.placeholder = originalPlaceholder;
                }
            }
        });

        // Form Submit
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const newPost = {
                id: document.getElementById('field-id').value,
                title: document.getElementById('field-title').value,
                shortDescription: document.getElementById('field-shortDesc').value,
                thumbnail: document.getElementById('field-thumb').value,
                thumbnailVideo: document.getElementById('field-thumbVid').value || null,
                description: document.getElementById('field-desc').value,
                classes: editingIndex >= 0 ? posts[editingIndex].classes : "group relative aspect-[4/3] overflow-hidden glass-panel cursor-pointer project-card",
                media: []
            };

            const mediaItems = mediaListEl.children;
            for (let i = 0; i < mediaItems.length; i++) {
                const row = mediaItems[i];
                const type = row.querySelector('.media-type').value;
                const src = row.querySelector('.media-src').value;
                if(src) {
                    newPost.media.push({ type, src });
                }
            }

            if (editingIndex >= 0) {
                posts[editingIndex] = newPost;
            } else {
                posts.push(newPost);
            }

            closeEditor();
            renderList();
        });

        init();

    </script>
</body>
</html>